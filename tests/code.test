<?php

/**
 * @file
 * Test file for Pin API module.
 */

include_once(dirname(__FILE__) . '/pinapi.test');

class PinAPICodeTestCase extends PinAPITestCase {

  /**
   * Implements getInfo().
   */
  public static function getInfo() {
    return array(
      'name' => t('Pin API Codes'),
      'description' => t('Tests codes'),
      'group' => t('Pin API'),
    );
  }

  /**
   * Implements setUp().
   */
  public function setUp() {
    parent::setUp();
    
    
  }

  /**
   * Implements tearDown().
   */
  public function tearDown() {
    
    
    parent::tearDown();
  }

  /**
   * Test Code Generation.
   */
  public function testCodeGeneration() {
    $count = db_result(db_query("SELECT COUNT(*) FROM {pinapi_code} WHERE gid = %d", $this->group->gid));
    $this->assertEqual($this->codes, $count, t('Code generation passed.'));
  }

  /**
   * Test Code Verification.
   */
  public function testCodeVerification() {
    $pass = TRUE;

    // Check each code and ensure they all verify.
    $result = db_query("SELECT * FROM {pinapi_code} WHERE gid = %d", $this->group->gid);
    while ( $code = db_fetch_object($result) ) {
      if ( !pinapi_code_verify($code->code, $this->group, $this->privileged_user) ) {
        $pass = FALSE;
      }
    }

    $this->assertTrue($pass, t('Codes were successfully verified.'));
  }

  /**
   * Test Code Redemption.
   */
  public function testCodeRedemption() {
    // Redeem every available code.
    $pass = TRUE;
    $result = db_query("SELECT * FROM {pinapi_code} WHERE gid = %d", $this->group->gid);
    while ( $code = db_fetch_object($result) ) {
      if ( !pinapi_code_redeem($code->code, $this->group, $this->privileged_user) ) {
        $pass = FALSE;
      }
    }

    $this->assertTrue($pass, t('Codes were successfully redeemed.'));

    // Verify every code is unavailable.
    $pass = TRUE;
    $result = db_query("SELECT * FROM {pinapi_code} WHERE gid = %d", $this->group->gid);
    while ( $code = db_fetch_object($result) ) {
      if ( pinapi_code_verify($code->code, $this->group, $this->privileged_user, TRUE) ) {
        $pass = FALSE;
      }
    }

    $this->assertTrue($pass, t('Redeemed codes were made unavailable.'));
  }

}
