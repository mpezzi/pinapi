<?php

/**
 * @file
 * Test file for Pin API module.
 */

include_once(dirname(__FILE__) . '/pinapi.test');

class PinAPICodeTestCase extends PinAPITestCase {

  /**
   * Implements getInfo().
   */
  public static function getInfo() {
    return array(
      'name' => t('Pin API Codes'),
      'description' => t('Tests codes'),
      'group' => t('Pin API'),
    );
  }

  /**
   * Implements setUp().
   */
  public function setUp() {
    parent::setUp();
    
    
  }

  /**
   * Implements tearDown().
   */
  public function tearDown() {
    
    
    parent::tearDown();
  }

  /**
   * Test Code Generation.
   */
  public function testCodeGeneration() {
    $codes = db_result(db_query("SELECT COUNT(*) FROM {pinapi_code} WHERE gid = %d", $this->group->gid));
    $this->assertEqual($codes, 100, t('Code generation passed.'));
  }

  /**
   * Test Code Verification.
   */
  public function testCodeVerification() {
    $code = db_fetch_object(db_query("SELECT * FROM {pinapi_code} WHERE gid = %d LIMIT 1", $this->group->gid));
    $this->assertTrue(pinapi_code_verify($code->code, $this->group, $this->privileged_user), t('Code was successfully verified.'));
  }

  /**
   * Test Code Redemption.
   */
  public function testCodeRedemption() {
    $code = db_fetch_object(db_query("SELECT * FROM {pinapi_code} WHERE gid = %d LIMIT 1", $this->group->gid));
    $this->assertTrue(pinapi_code_redeem($code->code, $this->group, $this->privileged_user), t('Code was successfully redeemed.'));
    $this->assertFalse(pinapi_code_verify($code->code, $this->group, $this->privileged_user, TRUE), t('Redeemed code was made unavailable'));
  }

}
