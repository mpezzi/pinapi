<?php 

/**
 * @file
 * Test file for Pin API module.
 */

class PinAPITestCase extends DrupalWebTestCase {
  public $user;
  public $pinapi_users;
  public $pinapi_pool_id = 1;
  
  private $_pinapi_pool;
  private $_pinapi_prizes;
  private $_pinapi_codes;
  
  /**
   * Implements setUp().
   */
  function setUp() {
    parent::setUp('pinapi');
    
    /*
    // Create a normal user.
    $permissions['authenticated'] = array(
      'access content',
      'redeem codes',
    );
    
    foreach ( $permissions as $role => $role_permissions ) {
      $this->pinapi_users[$role] = $this->drupalCreateUser($role_permissions);
    }
    */
    
    //$this->user = $this->drupalCreateUser(array('access content'));
    //$this->drupalLogin($this->user);
    
  }
  
  /**
   * Implements tearDown().
   */
  function tearDown() {
    
    // Delete the users.
    //foreach ( $this->pinapi_users as $account ) {
    //  user_delete(array(), $account->uid);
    //}
    
    db_query("DELETE FROM {pinapi_pool} WHERE pool_id = %d", $this->pinapi_pool_id);
    db_query("DELETE FROM {pinapi_prize} WHERE pool_id = %d", $this->pinapi_pool_id);
    db_query("DELETE FROM {pinapi_code} WHERE pool_id = %d", $this->pinapi_pool_id);
    
    parent::tearDown();
  }
  
  /**
   * Provide a populated pool with prizes and codes to test throughout the suite.
   */
  function testPinAPITestSuite() {
    $this->testPinAPITestPool();
    $this->testPinAPITestPrizes();
    $this->testPinAPITestCodes();
  }
  
  /**
   * Provide a populated pool.
   */
  function testPinAPITestPool() {
    if ( isset($this->_pinapi_pool) ) {
      return $this->_pinapi_pool;
    }
    
    // Set up a test pool.
    $pools = array(
      'content_id' => 1,
      'locked' => 1,
      'status' => 1,
    );
    
    pinapi_pools_set($pools);
    
    $this->_pinapi_pool = $pools[0];
    
    return $this->_pinapi_pool;
  }
  
  /**
   * Provide prizes for a pool.
   */
  function testPinAPITestPrizes() {
    if ( isset($this->_pinapi_prizes) ) {
      return $this->_pinapi_prizes;
    }
    
    $prizes = array(
      array('content_id' => 2, 'pool_id' => $this->pinapi_pool_id, 'quantity' => 100, 'status' => 1),
      array('content_id' => 3, 'pool_id' => $this->pinapi_pool_id, 'quantity' => 100, 'status' => 1),
      array('content_id' => 4, 'pool_id' => $this->pinapi_pool_id, 'quantity' => 100, 'status' => 1),
    );
    
    $this->_pinapi_prizes = pinapi_prizes_set($prizes);
    
    return $this->_pinapi_prizes;
  }
  
  /**
   * Provide codes for prizes.
   */
  function testPinAPITestCodes() {
    if ( isset($this->_pinapi_codes) ) {
      return $this->_pinapi_codes;
    }
    
    $generator = 'pinapi_code_generate_md5';
    foreach ( $this->_pinapi_prizes as $prize ) {
      for ( $i = 0; $i < $prize['quantity']; $i++ ) {
        $code = $generator($prize, $i);
        $this->_pinapi_codes[] = $code;
        pinapi_code_insert($code, $prize['pool_id']);
      }
    }
    
    return $this->_pinapi_codes;
  }
}
